version: '3.8'

services:
  # Provider Fuseki Server
  fuseki-provider:
    build:
      context: .
      dockerfile: Dockerfile.fuseki
    container_name: fuseki-provider
    ports:
      - "3030:3030"
    volumes:
      - ./data/sample-data.ttl:/staging/sample-data.ttl
      - ./init-fuseki.sh:/staging/init-fuseki.sh
      - fuseki-provider-data:/fuseki
    environment:
      - ADMIN_PASSWORD=pw
      - FUSEKI_DATASET_1=provider-ds
      - FUSEKI_DATASET_2=consumer-ds
      - TDB_VERSION=TDB2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Init script runner for provider
  fuseki-provider-init:
    image: curlimages/curl:latest
    container_name: fuseki-provider-init
    depends_on:
      fuseki-provider:
        condition: service_healthy
    volumes:
      - ./data/sample-data.ttl:/staging/sample-data.ttl
      - ./init-fuseki.sh:/staging/init-fuseki.sh
    environment:
      - FUSEKI_HOST=fuseki-provider:3030
    entrypoint: ["/bin/sh", "/staging/init-fuseki.sh"]
    restart: "no"

  # Consumer Fuseki Server
  fuseki-consumer:
    build:
      context: .
      dockerfile: Dockerfile.fuseki
    container_name: fuseki-consumer
    ports:
      - "3031:3030"
    volumes:
      - ./data/sample-data.ttl:/staging/sample-data.ttl
      - ./init-fuseki.sh:/staging/init-fuseki.sh
      - fuseki-consumer-data:/fuseki
    environment:
      - ADMIN_PASSWORD=pw
      - FUSEKI_DATASET_1=consumer-ds
      - TDB_VERSION=TDB2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Init script runner for consumer
  fuseki-consumer-init:
    image: curlimages/curl:latest
    container_name: fuseki-consumer-init
    depends_on:
      fuseki-consumer:
        condition: service_healthy
    volumes:
      - ./data/sample-data.ttl:/staging/sample-data.ttl
      - ./init-fuseki.sh:/staging/init-fuseki.sh
    environment:
      - FUSEKI_HOST=fuseki-consumer:3030
    entrypoint: ["/bin/sh", "/staging/init-fuseki.sh"]
    restart: "no"

  # EDC Provider Connector (simplified mock)
  edc-provider:
    image: node:18-alpine
    container_name: edc-provider
    ports:
      - "9191:9191"
    working_dir: /app
    volumes:
      - ./edc:/app
    command: npm start
    depends_on:
      - fuseki-provider
    environment:
      - PORT=9191
      - FUSEKI_URL=http://fuseki-provider:3030/provider-ds

  # EDC Consumer Connector (simplified mock)
  edc-consumer:
    image: node:18-alpine
    container_name: edc-consumer
    ports:
      - "9192:9192"
    working_dir: /app
    volumes:
      - ./edc:/app
    command: npm start
    depends_on:
      - fuseki-consumer
    environment:
      - PORT=9192
      - FUSEKI_URL=http://fuseki-consumer:3030/consumer-ds

  # Backend API Service
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: api
    ports:
      - "5000:5000"
    depends_on:
      fuseki-provider:
        condition: service_healthy
      fuseki-consumer:
        condition: service_healthy
      edc-provider:
        condition: service_started
      edc-consumer:
        condition: service_started
    environment:
      - NODE_ENV=production
      - EDC_CONNECTOR_URL=http://edc-provider:9191
      - FUSEKI_SERVER_1=http://fuseki-provider:3030/provider-ds
      - FUSEKI_SERVER_2=http://fuseki-consumer:3030/consumer-ds
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

  # Frontend GUI Service
  gui:
    build:
      context: ./gui
      dockerfile: Dockerfile
    container_name: gui
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    environment:
      - REACT_APP_API_URL=http://localhost:5000
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default

volumes:
  fuseki-provider-data:
  fuseki-consumer-data:

networks:
  default:
    name: dataspace-network
